# 
# Initialise variables and directories to prepare to run test suite.
# If run with argument  --start-apache  it will also start  httpd.
# If run with argument  --stop-apache   it will stop  httpd  and exit.
# If there is a problem before the test, "exit 77" skips the test (not fails it)
#
# Part of the ht://Dig package   <http://www.htdig.org/>
# Copyright (c) 1999, 2000 The ht://Dig Group
# For copyright details, see the file COPYING in your distribution
# or the GNU General Public License version 2 or later
# <http://www.gnu.org/copyleft/gpl.html>
#
# $Id: test_functions.in,v 1.10 2003/06/09 06:00:31 lha Exp $
#

if [ "$1" == --stop-apache ]
then
    if [ -n "$httpd"  -a  -f logs/httpd.pid ]
    then
	kill -15 `cat logs/httpd.pid`
        cp /dev/null logs/httpd.pid
	sleep 2
    fi
else

testdir=`pwd`

perl=@PERL@

@SET_MAKE@

if [ -z "$MAKE" ]
then
	echo "no make command found"
	exit 77
fi

#
# Prepare http server
#
(
    cd conf
    $MAKE user="@USER@" modules="@APACHE_MODULES@" testdir=$testdir all > /dev/null
)

httpd=@APACHE@

# if apache requested, either start it or warn it was not configured.
if [ "$1" == --start-apache ]
then

    if [ -z "$httpd" ]
    then
	    prog_name=`basename $0`
	    echo "Run configure with --with-apache=<httpd path> to run $prog_name."
	    exit 77
    fi

    if [ ! -d logs ] 
    then 
      mkdir -p logs
    else
      if [ -f logs/httpd.pid ]
      then
	kill -15 `cat logs/httpd.pid`
        cp /dev/null logs/httpd.pid
	sleep 2
      fi
    fi
    if ! $httpd -f $testdir/conf/httpd.conf
    then
        echo
        echo "****Could not start apache. This test may fail, but that is not ht://Dig's fault"
        echo
    fi
fi

#
# Prepare htdig test environment
#
rm -fr var/htdig
rm -fr var/htdig2
mkdir -p var/htdig
mkdir -p var/htdig2

htdig=../htdig/htdig
htsearch=../htsearch/htsearch
htmerge=../httools/htmerge
htpurge=../httools/htpurge
htstat=../httools/htstat
htdump=../httools/htdump
htload=../httools/htload

#
# Default index description used for testing
#
export MIFLUZ_CONFIG ; MIFLUZ_CONFIG=${srcdir}/mifluz.conf

rm -f test test_weakcmpr __db*

#
# Provide a unified means for scripts to clean up.
#
fail() {
    echo "$1"
    if [ -n "$httpd"  -a  -f logs/httpd.pid ]
    then
      kill -15 `cat logs/httpd.pid`
      cp /dev/null logs/httpd.pid
      sleep 2
    fi
    exit 1
}

fi	# $1 != --stop-apache
