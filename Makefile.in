# Main Makefile for ht://Dig
# Copyright (c) 1995-1999 The ht://Dig Group

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
   
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
   
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

top_srcdir=             @top_srcdir@
srcdir=                 @srcdir@
VPATH=                  @srcdir@
INSTALL=		@INSTALL@

top_builddir= .
include Makefile.config

DIRS=		db/dist rx \
		htlib htcommon htfuzzy htdig \
		htsearch htmerge htnotify
INSTALLDIRS=	htfuzzy htdig \
		htsearch htmerge htnotify
HTDIRS=		htlib htcommon htfuzzy htdig \
		htsearch htmerge htnotify
CREATEDIRS=	$(BIN_DIR) $(CONFIG_DIR) $(COMMON_DIR) $(DATABASE_DIR) \
		$(IMAGE_DIR) $(CGIBIN_DIR) $(SEARCH_DIR)
NO_DIST=	BETA.DIST htdig/*.conf htmerge/*.conf htsearch/*.conf \
		htfuzzy/*.conf *.gz */*.gz *~ */*~ mailarchive \
		.\#* */.\#* */*/.\#* \
		CVS */CVS */*/CVS */*/*/CVS
IMAGES=		button1.gif button2.gif button3.gif button4.gif button5.gif \
		button6.gif button7.gif button8.gif button9.gif buttonl.gif \
		buttonr.gif button10.gif htdig.gif star.gif star_blank.gif

all:
	@for i in $(DIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) all) \
		|| case "$(MFLAGS)" in *k*) fail=yes;; *) exit 1;; esac; \
	done && test -z "$$fail"

clean:
	rm -f *~
	@for i in $(DIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) clean) \
		|| case "$(MFLAGS)" in *k*) fail=yes;; *) exit 1;; esac; \
	done && test -z "$$fail"

mostlyclean:
	rm -f *~
	@for i in $(HTDIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) mostlyclean) \
		|| case "$(MFLAGS)" in *k*) fail=yes;; *) exit 1;; esac; \
	done && test -z "$$fail"


distclean:
	rm -rf config.cache config.status config.log config.h \
		makedp *.gz test *~ include/htconfig.h
	rm -f @RX_DIR@/config.cache @RX_DIR@/config.status
	@for i in $(DIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) distclean) \
		|| case "$(MFLAGS)" in *k*) fail=yes;; *) exit 1;; esac; \
	done && test -z "$$fail"
	rm -f Makefile Makefile.config stamp-h

install:	all
	@echo "Installing ht://Dig"
	@echo ""
	@echo "Creating directories (if needed)..."
	-@for i in $(CREATEDIRS); do \
		$(top_srcdir)/mkinstalldirs $$i; \
	done && test -z "$$fail"
	@echo ""
	@echo "Installing individual programs..."
	@for i in $(INSTALLDIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) install); \
	done && test -z "$$fail"
	@echo ""
	@echo "Installing default configuration files..."
	@if [ ! -f $(CONFIG_DIR)/htdig.conf ]; then sed -e s%@DATABASE_DIR@%$(DATABASE_DIR)% -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/htdig.conf >$(CONFIG_DIR)/htdig.conf; echo $(CONFIG_DIR)/htdig.conf;fi
	@if [ ! -f $(COMMON_DIR)/bad_words ]; then $(INSTALL) -m 0664 $(top_srcdir)/installdir/bad_words $(COMMON_DIR); echo $(COMMON_DIR)/bad_words; fi
	@if [ ! -f $(SEARCH_DIR)/$(SEARCH_FORM) ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/search.html >$(SEARCH_DIR)/$(SEARCH_FORM); echo $(SEARCH_DIR)/$(SEARCH_FORM);fi
	@if [ ! -f $(COMMON_DIR)/footer.html ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/footer.html >$(COMMON_DIR)/footer.html; echo $(COMMON_DIR)/footer.html;fi
	@if [ ! -f $(COMMON_DIR)/header.html ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/header.html >$(COMMON_DIR)/header.html; echo $(COMMON_DIR)/header.html;fi
	@if [ ! -f $(COMMON_DIR)/wrapper.html ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/wrapper.html >$(COMMON_DIR)/wrapper.html; echo $(COMMON_DIR)/wrapper.html;fi
	@if [ ! -f $(COMMON_DIR)/nomatch.html ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/nomatch.html >$(COMMON_DIR)/nomatch.html; echo $(COMMON_DIR)/nomatch.html;fi
	@if [ ! -f $(COMMON_DIR)/syntax.html ]; then sed -e s%@IMAGEDIR@%$(IMAGE_URL_PREFIX)% $(top_srcdir)/installdir/syntax.html >$(COMMON_DIR)/syntax.html; echo $(COMMON_DIR)/syntax.html;fi
	@if [ ! -f $(COMMON_DIR)/english.0 ]; then $(INSTALL) -m 0664 $(top_srcdir)/installdir/english.0 $(COMMON_DIR); echo $(COMMON_DIR)/english.0;fi
	@if [ ! -f $(COMMON_DIR)/english.aff ]; then $(INSTALL) -m 0664 $(top_srcdir)/installdir/english.aff $(COMMON_DIR); echo $(COMMON_DIR)/english.aff;fi
	@if [ ! -f $(COMMON_DIR)/synonyms ]; then $(INSTALL) -m 0664 $(top_srcdir)/installdir/synonyms $(COMMON_DIR); echo $(COMMON_DIR)/synonyms;fi
	@echo "Installing images..."
	@for i in $(IMAGES); do \
		if [ ! -f $(IMAGE_DIR)/$$i ]; then $(INSTALL) -m 0664 $(top_srcdir)/installdir/$$i $(IMAGE_DIR)/$$i; echo $(IMAGE_DIR)/$$i;fi; \
	done && test -z "$$fail"
	@echo "Creating rundig script..."
	@if [ ! -f $(BIN_DIR)/rundig ]; then \
		sed -e s%@BIN_DIR@%$(BIN_DIR)% -e s%@COMMON_DIR@%$(COMMON_DIR)% -e s%@DATABASE_DIR@%$(DATABASE_DIR)% $(top_srcdir)/installdir/rundig >$(BIN_DIR)/rundig; \
		chmod 755 $(BIN_DIR)/rundig; \
	fi
	@echo "Installation done."
	@echo ""
	@echo "Before you can start searching, you will need to create a"
	@echo "search database.  A sample script to do this has been"
	@echo "installed as " $(BIN_DIR)/rundig

install-strip:
	$(MAKE) INSTALL_PROGRAM='$(INSTALL_PROGRAM) -s' \
		install
#installdirs: mkinstalldirs
#        $(srcdir)/mkinstalldirs $(bindir) $(datadir) \
#                                $(libdir) $(infodir) \
#                                $(mandir)

depend:
	@for i in $(HTDIRS); do \
		(cd $$i; $(MAKE) $(MFLAGS) depend); \
	done && test -z "$$fail"

dist:
	rm -rf $(DISTDIR)
	mkdir $(DISTDIR)
	tar cf - . | (cd $(DISTDIR); tar xf -)
	(cd $(DISTDIR); $(MAKE) distclean)
	-for i in $(DIRS); do \
		(cd $(DISTDIR)/$$i; rm -fr RCS CVS docu .#\*); \
	done && test -z "$$fail"
	(cd $(DISTDIR); rm -rf $(NO_DIST))
	(cd $(DISTDIR)/..; tar czf $(DIST).tar.gz $(DIST))

tar:
	tar czf ht.tar.gz --exclude ht.tar.gz .

# automatic re-running of configure if the configure.in file has changed
${srcdir}/configure: configure.in aclocal.m4
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file
${srcdir}/include/htconfig.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in aclocal.m4
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

include/htconfig.h: stamp-h
stamp-h: config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
Makefile.config: Makefile.config.in config.status
	./config.status
config.status: configure
	./config.status --recheck
